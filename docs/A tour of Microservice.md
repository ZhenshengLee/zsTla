# 微服务

服务是一种机制，通过它可以访问一个或者多个能力（执行命令，查询，触发事件等）

微服务是具有“最小”公开接口的服务

- 隔离

- 自治

- 松耦合

- 单一职责

- 可管理

- 独立部署升级

- 快速迭代演化

互联网时代，软件越来越大，升级也越来越快，软件分成小部分，使用不同的技术栈；升级方便。

## 单体架构

Monolith

Microlith

Microsystems

分布式单体架构

把工作分为多个服务，共用一个数据库。

## 一个微服务中的典型架构

服务发现

Anti层，隔离不相关的东西

鉴权

安全

ServiceGateway，



## 官方网站提供的设计模式

边车模式sidecar

## 微服务的划分

架构转型之前一定要清晰地知道，为什么要转型

坏消息：没有固定规则

要依赖于微服务所处的系统的具体情况而定

一些启发式原则：

最小公开接口；最小数据一致性；考虑系统的具体情况做权衡

数据一致性问题是微服务系统中出现的最大问题

A 服务和B 服务查询同一个数据时的数据在任何时候都是一致的，需要保持一致的数据要最小化

更坏的消息，划分好了之后才是真正困难的开始，因为微服务系统首先是一个分布式系统，分布式系统设计本来就很难

发消息如何保证发送到位了，如果丢了怎么办？

通信，共识，，，

每个服务对外提供一些服务。

服务于服务之间交互以保持数据一致性

保持数据同步的手段：同步，远程RPC去访问数据

服务可用性和可靠性

可用性：

系统可用时间/系统运行时间

连续运行两年，但是恢复要一个月，说明可用性不好

可靠性：

连续正常工作的整的时间

可靠性高：连续运行两年

一周重启一次，重启很快，说明可靠性不高

消息投递语义

exactly once

at most once

at least once

数据共享选择

share nothing

share everything

容量规划

Amdahl's law



节点数和并行程度的关系

测试

soak测试，长时间正常运转

stress测试，负载越来越高

spike测试，突发测试

load测试，负载测试，突然高一点

性能瓶颈

CPU满负荷时，系统吞吐量是下降的

如果吞吐量变化不大，不下降，则说明系统没有瓶颈

## 如果没有读过论文，千万别做微服务设计

。。。

## 小结

功能划分

简单，隔离错误

分布式结构

伸缩，可用

通信协议选择

传输可靠性，安全性，业务特性

API定义

易用，避免数据重复，小消息，大计算

确定重试策略

at most once, at least once exactly once，迷瞪性

数据共享策略

无共享，完全共享，部分共享

容量规划

容量测试，消除瓶颈，平衡，反压，负载管控

集群蓝图

节点类型，资源要求，网络架构

运维

自动化智能化

