





# 使用tla设计容错服务



## 例子



服务1依赖服务2-4



设计考虑



- 正常业务流程

- 容错假设和表达

- 容错策略



一个dispatcher 和2个executor, request 和 response



## 正常业务流程



使用PlusCal进行流程建模



计算平方和，将数分发给两个执行者，执行者做乘法，分发者做加法



编写pluscal，CTRL+T翻译成tla+语言





## 总结



pluscal代码100多行，模拟了4个进程，还有一个检测进程



任务：求平方和，分派者和接受者

假设：下次一定可达，消息一定能够可靠的派发到对方，直接把数送到接受者队列中



模拟：进程故障，检测故障进程，重新分派工作



给实际工作中的故障定位带来便利



实际工作中：

进程中抓日志，多个进程抓日志，根据时间戳信息，进行对比，



四个进程做TDD？

很难做到



tla+中看trace，十几个就行了



## 认识



好玩的

可以帮助我们解决并发问题



## 快速发现BUG



计算1,2改成计算1,2,3

立马发现新BUG！



## 分析logTrace



检测到e3挂

分配任务给e1-1 e2-2 e3-3

e1返回了一个结果1

收集着收集结果1

检测者检测到e3挂之后给分配者发送了消息

分配者将e3的任务重新分配给e1

e1算完，返回结果9

e3算完，返回结果9

(并发问题：检测到e3挂和e3计算是并发的，所以检测到e3挂之后，e3依然返回了一个结果9)

(有可能是算完挂了，也有可能是算之前挂的)

（误检测？或者只处理一份数据）

